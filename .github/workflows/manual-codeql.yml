name: Manual CodeQL Analysis (JavaScript)

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  manual-js-analysis:
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      # 1. Download CodeQL Bundle
      - name: Download CodeQL Bundle
        run: |
          echo "Downloading CodeQL Bundle..."
          # Note: We use the same bundle; it contains support for all languages.
          wget -q https://github.com/github/codeql-action/releases/download/codeql-bundle-v2.16.0/codeql-bundle-linux64.tar.gz
          tar -xzf codeql-bundle-linux64.tar.gz
          echo "$PWD/codeql" >> $GITHUB_PATH

      # 2. Create the Database (JavaScript)
      # This supports both .js and .ts files automatically.
      - name: Create CodeQL Database
        run: |
          mkdir -p codeql-dbs
          codeql database create ./codeql-dbs/js-repo-db \
            --language=javascript \
            --source-root=. \
            --overwrite

      # 3. Run Analysis (Generate SARIF)
      # We use the 'javascript-security-extended.qls' suite included in the bundle.
      - name: Analyze (SARIF)
        run: |
          mkdir -p results
          codeql database analyze ./codeql-dbs/js-repo-db \
            javascript-security-extended.qls \
            --format=sarif-latest \
            --output=./results/javascript-results.sarif

      # 4. Run Analysis (Generate CSV for Logs)
      - name: Analyze (CSV for Logs)
        run: |
          codeql database analyze ./codeql-dbs/js-repo-db \
            javascript-security-extended.qls \
            --format=csv \
            --output=./results/javascript-results.csv

      # 5. Output Results to Build Logs
      - name: Print Results to Console
        run: |
          echo "================ JS ANALYSIS RESULTS ================"
          if [ -s ./results/javascript-results.csv ]; then
            cat ./results/javascript-results.csv
          else
            echo "No alerts found."
          fi
          echo "====================================================="

      # 6. Upload SARIF to GitHub
      - name: Upload SARIF
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: ./results/javascript-results.sarif
          category: manual-javascript
